# Technology Decisions

## Instructions & Guiding Principles
- **Instructions**: Consult this document before introducing new libraries, software design patterns, or architectural systems. If there is a decision already recorded related to the change, attempt to adopt the existing decision or pattern. If that is not feasible, prompt a discussion to update this document and adopt the new solution.
- **Testing Mandate**: Ensure all new features or significant bug fixes include corresponding RSpec tests. Aim to maintain or increase test coverage.
- **Code Style Enforcement**: Adhere strictly to the project's code style guidelines. Run `bundle exec rubocop` locally before finalizing changes to ensure compliance.
- **Documentation Updates**: Update relevant documentation (e.g., `README.md`, command help text generated by Thor, `DECISIONS.md`) whenever features are added, changed, or removed.
- **Commit Message Style**: Follow the Conventional Commits specification for structuring commit messages (e.g., `feat: add issue linking`, `fix: correct pagination logic`).
- **User Experience Focus**: Prioritize a clear and intuitive user experience. Ensure command outputs are informative, error messages are helpful, and flags/options are logical.

## Core Technology Stack
- **Ruby**: Primary language for the CLI tool due to its excellent CLI support, readable syntax, and robust ecosystem.
- **Thor**: Framework for building the command-line interface, providing a clean DSL for commands and options.
- **Bundler**: Dependency management tool.
- **RSpec**: Primary testing framework for unit and integration tests.

## API Integration & Authentication
- **Linear API**: Using Linear's GraphQL endpoint for all data interactions.
- **HTTP Client**: Using `httparty` gem for API requests.
- **Authentication**: Linear API keys stored in environment variables or configuration files (YAML for non-sensitive, dotenv for environment variables).
- **API Timeouts**: Configurable timeouts (default 30s request, 10s connection) applied to all API requests for improved reliability.

## Project Architecture
- **Command-Line Interface**: Structured as a CLI with subcommands for different operations.
  - **CLI Implementation**: Thor-based CLI class extracted into dedicated file (`lib/linear_cli/cli.rb`) for better separation of concerns.
  - **CLI Structure**: Refactored CLI class to use private helper methods for better organization and maintainability.
- **Models**: Ruby classes representing Linear entities (issues, projects, teams).
- **Services**: Separate service classes handling API communication and business logic.

## Testing Strategy
- **API Mocking**: Simple mock response approach using a class-level `mock_response` attribute for API client testing.
  - **Rationale**: Avoids complexity of WebMock/VCR for unit tests, though VCR can still be used for integration tests.
  - **Benefits**: Simplified test setup, decoupled tests from HTTP implementation, easier maintenance.
  - **Enhanced Protection**: Enforced prevention of real API calls in test environments by default. Tests that attempt to make real API calls will fail unless explicitly allowed.
  - **Implementation**: Combines WebMock's `disable_net_connect!` with API client checks that prevent calls when `mock_response` is not set.
  - **Override**: Tests that need to make real API calls can set `LinearCli::API::Client.allow_real_api_calls_in_test = true` when necessary.
- **Terminal Output in Tests**: Use simplified text output instead of TTY::Table rendering in test environments to avoid terminal capability issues.
  - **Rationale**: TTY::Table requires terminal capabilities not present in test runners (e.g., StringIO).
  - **Implementation**: Check for test environment (`RACK_ENV` or `RAILS_ENV`) and use basic string formatting.
  - **Benefits**: Tests run without errors, output remains readable, production retains rich formatting.
- **RuboCop Integration**: Integrated into the test suite (`Rakefile`) to enforce code style and quality automatically.

## Security Practices
- **Input Validation**: Dedicated `InputValidator` module validates and sanitizes all user inputs (issue IDs, emails, etc.) to reduce injection risks and improve reliability. Includes bounds checking.
- **Safe Mode (Default On)**: Read-only mode enabled by default to prevent accidental mutations. Requires explicit `--allow-mutations` flag for data changes.
  - **Evolution**: Initially introduced as `--safe-mode` (off by default), then changed to be on by default for improved safety ("safe by default" principle).

## Display, Output & Logging
- **Table Rendering**:
  - **Evolution**: Moved from `terminal-table` and `colorize` to centralized `LinearCli::UI::TableRenderer` for consistent styling and test environment handling.
  - **Orientation**: Forced horizontal orientation (`resize: false`) to fix width errors.
  - **Simplification**: Removed explicit width settings, relying on default TTY::Table handling to avoid errors.
- **Progress Indication & Logging**:
  - **Evolution**: Replaced TTY progress bars with simple timestamped logging (`Logger` class) for reduced complexity, better non-TTY compatibility, and clearer output.
  - **Test Environment**: Logging output is suppressed in test environments to keep test output clean and focused on test results.
  - **Implementation**: Logger detects test environments using the same approach as `TableRenderer` (checking for RSpec, RACK_ENV, RAILS_ENV, and TTY capability).

## Pagination & Data Handling
- **Core Implementation**: Cursor-based pagination with `--all` flag to fetch all data beyond default limits.
- **Standardization**: Default page size of 50 items (`DEFAULT_PAGE_SIZE`).
- **API Optimization**: GraphQL queries filter by `team_id` at the API level for improved performance.
- **Evolution**:
  - Extracted logic into reusable `fetch_paginated_data` method in the API client.
  - Improved count logic to use `totalCount` when available, falling back to node counting.
  - Redesigned loop logic to correctly handle `--all` flag, limits, and cursor management.

## GraphQL Schema Adaptation
- **Issue Count**: Adapted count queries when `totalCount` field was found unavailable on `IssueConnection`.
- **Project Teams**: Updated queries and processing logic when `Project.team` changed to `Project.teams` (connection) and added `lead` field, modifying `WorkloadCalculator` to handle multi-team projects.

## Analytics Module Architecture
- **Initial Design**: Dedicated module with `Analytics::Reporting` and `Analytics::Display` components using a functional approach.
- **Service-Based Refactoring**: Extracted logic into focused services:
  - `DataFetcher`: Handles API data retrieval
  - `PeriodFilter`: Manages time-based filtering
  - `WorkloadCalculator`: Processes workload metrics
  - `MonthlyProcessor`: Handles monthly data grouping
- **Team-Focused Analysis**: Analytics commands focus on single team analysis for clarity.
- **Defensive Programming**: Methods defensively handle nil inputs (e.g., converting nil issues to empty arrays) to improve robustness.

## Feature Evolution & Removals

### Engineer/Contributor Workload Analysis
- **Initial Implementation**: Added analysis showing project contributions over time by engineer (team → project → engineer structure), calculated using story points, with a 6-month trend view.
- **Evolution**:
  - Enhanced with time period filtering, summary/detailed views, completion date usage, and more context (issue counts, point totals).
  - **Simplified**: Standardized on a 6-month monthly summary view followed by project details for clarity.
  - **Team Focus**: Changed to focus on one team at a time via `team_workload` command (deprecating `engineer_workload`) for more focused reporting. Renamed "engineers" to "contributors".
  - **Contribution Definition**: Refined to only consider completed issues as contributions. Tasks without story point estimates are counted as 1 point of effort to properly account for all completed work.
- **Removal**: The `engineer_workload` command has been completely removed from the codebase after being deprecated, leaving only the more focused `team_workload` command.

### Capitalization Analysis (Removed)
- **Initial Implementation**: Added software capitalization analysis based on issue labels.
- **Evolution**:
  - Changed to project-based analysis (checking project labels first, then issue labels for backward compatibility).
  - Enhanced reporting to track specific projects, engineer workload allocation, and time-period filtering.
- **Removal**: The `capitalization` command and related functionality were removed as they were no longer needed, simplifying the codebase.

### Other Removals
- **Generator Command**: Removed `Commands::Generator` and associated `API::DataGenerator`, `API::Queries::Generator` as it was superseded by analytics tooling.

## Code Quality & Exception Handling
- **Exception Handling**: Removed error handling that obscured underlying issues, retaining only necessary cleanup blocks where exceptions are re-raised. Ensured `activesupport` dependency was explicit.